<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sequencer Visual Engine Tests</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            margin: 20px;
            background: #f5f5f5;
            color: #333;
        }
        
        h1 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        
        .test-section {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .test-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        
        .btn.primary { background: #3498db; color: white; }
        .btn.primary:hover { background: #2980b9; }
        .btn.success { background: #27ae60; color: white; }
        .btn.success:hover { background: #229954; }
        .btn.danger { background: #e74c3c; color: white; }
        .btn.danger:hover { background: #c0392b; }
        .btn.warning { background: #f39c12; color: white; }
        .btn.warning:hover { background: #e67e22; }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        
        .control-group label {
            min-width: 100px;
            font-weight: bold;
        }
        
        .control-group input, .control-group select {
            padding: 4px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: inherit;
        }
        
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .test-result.success {
            background: #d5f4e6;
            border: 1px solid #27ae60;
            color: #1e8449;
        }
        
        .test-result.error {
            background: #fadbd8;
            border: 1px solid #e74c3c;
            color: #a93226;
        }
        
        .test-result.info {
            background: #d6eaf8;
            border: 1px solid #3498db;
            color: #1f618d;
        }
        
        .canvas-container {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        
        .canvas-wrapper {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            background: white;
            text-align: center;
        }
        
        .canvas-wrapper h3 {
            margin: 0 0 10px 0;
            color: #495057;
        }
        
        .stats-display {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .stat-label {
            font-weight: bold;
            color: #495057;
        }
        
        .stat-value {
            color: #007bff;
            font-family: monospace;
        }
        
        #testLog {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .pattern-selector {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .pattern-display {
            font-family: monospace;
            font-size: 16px;
            letter-spacing: 2px;
            text-align: center;
            margin: 10px 0;
            padding: 10px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .theme-selector {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <h1>üé® Sequencer Visual Engine Test Suite</h1>
    
    <!-- TEST RESULTS SUMMARY -->
    <div class="test-section">
        <h2>üìä Test Results Summary</h2>
        <div id="testSummary">
            <div class="test-result info">Ready to run tests...</div>
        </div>
        <div class="test-controls">
            <button class="btn primary" onclick="runAllTests()">Run All Tests</button>
            <button class="btn warning" onclick="clearResults()">Clear Results</button>
        </div>
    </div>
    
    <!-- BASIC FUNCTIONALITY TESTS -->
    <div class="test-section">
        <h2>üß™ Basic Functionality Tests</h2>
        <div class="test-controls">
            <button class="btn primary" onclick="testInitialization()">Test Initialization</button>
            <button class="btn primary" onclick="testCanvasSetup()">Test Canvas Setup</button>
            <button class="btn primary" onclick="testRendering()">Test Rendering</button>
            <button class="btn primary" onclick="testResponsiveResize()">Test Responsive Resize</button>
        </div>
        <div id="basicTestResults"></div>
    </div>
    
    <!-- VISUAL DEMONSTRATION -->
    <div class="test-section">
        <h2>üé® Visual Demonstration</h2>
        <div class="canvas-container">
            <div class="canvas-wrapper">
                <h3>Main Test Canvas</h3>
                <div id="testCanvasContainer" style="width: 300px; height: 300px; border: 1px solid #ccc;">
                    <canvas id="testCanvas"></canvas>
                </div>
            </div>
            <div class="canvas-wrapper">
                <h3>Secondary Test Canvas</h3>
                <div id="testCanvasContainer2" style="width: 200px; height: 200px; border: 1px solid #ccc;">
                    <canvas id="testCanvas2"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- PATTERN TESTING -->
    <div class="test-section">
        <h2>üéµ Pattern Testing</h2>
        <div class="pattern-selector">
            <h3>Test Patterns</h3>
            <div class="test-controls">
                <button class="btn success" onclick="loadTestPattern('tresillo')">Tresillo (0x49:8)</button>
                <button class="btn success" onclick="loadTestPattern('fourOnFloor')">Four-on-floor</button>
                <button class="btn success" onclick="loadTestPattern('euclidean')">Euclidean E(5,8)</button>
                <button class="btn success" onclick="loadTestPattern('polygon')">Pentagon P(5,0)</button>
                <button class="btn success" onclick="loadTestPattern('random')">Random Pattern</button>
            </div>
            <div class="pattern-display" id="currentPattern">Click a pattern to load</div>
        </div>
        
        <div class="test-controls">
            <button class="btn primary" onclick="testPatternUpdate()">Test Pattern Updates</button>
            <button class="btn primary" onclick="testCogCalculation()">Test CoG Calculation</button>
            <button class="btn primary" onclick="testStepToggling()">Test Step Toggling</button>
        </div>
        <div id="patternTestResults"></div>
    </div>
    
    <!-- PLAYBACK ANIMATION TESTS -->
    <div class="test-section">
        <h2>üé¨ Playback Animation Tests</h2>
        <div class="test-controls">
            <button class="btn success" onclick="startPlaybackTest()">Start Playback Animation</button>
            <button class="btn danger" onclick="stopPlaybackTest()">Stop Playback</button>
            <button class="btn warning" onclick="testAnimationPerformance()">Test Animation Performance</button>
        </div>
        <div class="control-group">
            <label>Tempo:</label>
            <input type="range" id="tempoSlider" min="60" max="180" value="120">
            <span id="tempoDisplay">120</span> BPM
        </div>
        <div id="playbackTestResults"></div>
    </div>
    
    <!-- VISUAL THEMES TESTING -->
    <div class="test-section">
        <h2>üé® Visual Themes Testing</h2>
        <div class="theme-selector">
            <button class="btn primary" onclick="applyTheme('default')">Default Theme</button>
            <button class="btn primary" onclick="applyTheme('dark')">Dark Theme</button>
            <button class="btn primary" onclick="applyTheme('highContrast')">High Contrast</button>
            <button class="btn primary" onclick="applyTheme('minimal')">Minimal Theme</button>
        </div>
        <div class="test-controls">
            <button class="btn primary" onclick="testThemeApplication()">Test Theme Changes</button>
            <button class="btn primary" onclick="testConfigUpdates()">Test Config Updates</button>
        </div>
        <div id="themeTestResults"></div>
    </div>
    
    <!-- INTERACTION TESTS -->
    <div class="test-section">
        <h2>üñ±Ô∏è Interaction Tests</h2>
        <div class="test-controls">
            <button class="btn primary" onclick="testClickDetection()">Test Click Detection</button>
            <button class="btn primary" onclick="testHoverEffects()">Test Hover Effects</button>
            <button class="btn primary" onclick="testPatternEvents()">Test Pattern Events</button>
        </div>
        <div id="interactionTestResults"></div>
    </div>
    
    <!-- PERFORMANCE TESTS -->
    <div class="test-section">
        <h2>üöÄ Performance Tests</h2>
        <div class="test-controls">
            <button class="btn warning" onclick="testRenderPerformance()">Test Render Performance</button>
            <button class="btn warning" onclick="testLargePatterns()">Test Large Patterns</button>
            <button class="btn warning" onclick="testMemoryUsage()">Test Memory Usage</button>
        </div>
        <div id="performanceTestResults"></div>
    </div>
    
    <!-- VISUAL ENGINE STATISTICS -->
    <div class="test-section">
        <h2>üìà Visual Engine Statistics</h2>
        <div class="stats-display">
            <div class="stats-grid" id="visualStats">
                <!-- Stats will be populated here -->
            </div>
        </div>
        <button class="btn primary" onclick="updateStats()">Refresh Stats</button>
    </div>
    
    <!-- TEST LOG -->
    <div class="test-section">
        <h2>üìù Test Log</h2>
        <div id="testLog"></div>
    </div>

    <!-- Load dependencies -->
    <script src="math-core.js"></script>
    <script src="pattern-analysis.js"></script>
    <script src="sequencer-visual.js"></script>
    
    <script>
        // Global test state
        let visualEngine = null;
        let visualEngine2 = null;
        let testResults = {
            passed: 0,
            failed: 0,
            total: 0
        };
        let playbackInterval = null;
        let currentStep = 0;
        
        // Test patterns
        const testPatterns = {
            tresillo: {
                steps: [true, false, false, true, true, false, false, true],
                stepCount: 8,
                name: 'Tresillo (0x49:8)'
            },
            fourOnFloor: {
                steps: [true, false, false, false, true, false, false, false, true, false, false, false, true, false, false, false],
                stepCount: 16,
                name: 'Four-on-floor'
            },
            euclidean: {
                steps: [true, false, true, false, true, false, true, false],
                stepCount: 8,
                name: 'Euclidean E(5,8)'
            },
            polygon: {
                steps: [true, false, false, false, true, false, false, false, true, false],
                stepCount: 10,
                name: 'Pentagon P(5,0)'
            }
        };
        
        // Initialize engines
        function initializeEngines() {
            if (!visualEngine) {
                try {
                    visualEngine = new SequencerVisualEngine('testCanvas', 'testCanvasContainer');
                    logMessage('üé® Main visual engine created');
                } catch (error) {
                    logMessage(`‚ùå Failed to create main engine: ${error.message}`);
                    return false;
                }
            }
            
            if (!visualEngine2) {
                try {
                    visualEngine2 = new SequencerVisualEngine('testCanvas2', 'testCanvasContainer2');
                    logMessage('üé® Secondary visual engine created');
                } catch (error) {
                    logMessage(`‚ùå Failed to create secondary engine: ${error.message}`);
                }
            }
            
            return true;
        }
        
        // Logging function
        function logMessage(message) {
            const log = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            log.textContent += `[${timestamp}] ${message}\n`;
            log.scrollTop = log.scrollHeight;
            console.log(message);
        }
        
        // Test result display
        function displayResult(containerId, testName, passed, details = '') {
            const container = document.getElementById(containerId);
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${passed ? 'success' : 'error'}`;
            resultDiv.innerHTML = `
                <strong>${testName}:</strong> ${passed ? '‚úÖ PASSED' : '‚ùå FAILED'}
                ${details ? `<br><small>${details}</small>` : ''}
            `;
            container.appendChild(resultDiv);
            
            testResults.total++;
            if (passed) {
                testResults.passed++;
            } else {
                testResults.failed++;
            }
            
            updateTestSummary();
            logMessage(`${testName}: ${passed ? 'PASSED' : 'FAILED'} ${details}`);
        }
        
        // Update test summary
        function updateTestSummary() {
            const summary = document.getElementById('testSummary');
            const passRate = testResults.total > 0 ? (testResults.passed / testResults.total * 100).toFixed(1) : 0;
            
            summary.innerHTML = `
                <div class="test-result ${testResults.failed === 0 ? 'success' : 'error'}">
                    <strong>Tests:</strong> ${testResults.passed}/${testResults.total} passed (${passRate}%)
                    ${testResults.failed > 0 ? `<br><strong>Failures:</strong> ${testResults.failed}` : ''}
                </div>
            `;
        }
        
        // Clear all test results
        function clearResults() {
            testResults = { passed: 0, failed: 0, total: 0 };
            document.getElementById('testLog').textContent = '';
            document.querySelectorAll('.test-result').forEach(el => el.remove());
            updateTestSummary();
            logMessage('üßπ Test results cleared');
        }
        
        // === BASIC FUNCTIONALITY TESTS ===
        
        function testInitialization() {
            logMessage('üß™ Testing initialization...');
            
            const success = initializeEngines();
            displayResult('basicTestResults', 'Visual Engine Initialization', success);
            
            if (success && visualEngine) {
                const hasCanvas = !!visualEngine.canvas;
                const hasContext = !!visualEngine.ctx;
                const hasContainer = !!visualEngine.container;
                
                displayResult('basicTestResults', 'Canvas Access', hasCanvas);
                displayResult('basicTestResults', 'Context Access', hasContext);
                displayResult('basicTestResults', 'Container Access', hasContainer);
            }
        }
        
        function testCanvasSetup() {
            logMessage('üß™ Testing canvas setup...');
            
            if (!visualEngine) {
                displayResult('basicTestResults', 'Canvas Setup', false, 'Engine not initialized');
                return;
            }
            
            const canvas = visualEngine.canvas;
            const hasDimensions = canvas.width > 0 && canvas.height > 0;
            const isSquare = canvas.width === canvas.height;
            const configMatch = canvas.width === visualEngine.config.canvasSize;
            
            displayResult('basicTestResults', 'Canvas Dimensions', hasDimensions,
                `${canvas.width}x${canvas.height}px`);
            displayResult('basicTestResults', 'Square Canvas', isSquare);
            displayResult('basicTestResults', 'Config Sync', configMatch);
        }
        
        function testRendering() {
            logMessage('üß™ Testing rendering...');
            
            if (!visualEngine) {
                displayResult('basicTestResults', 'Rendering', false, 'Engine not initialized');
                return;
            }
            
            try {
                // Test basic render
                visualEngine.render();
                displayResult('basicTestResults', 'Basic Render', true);
                
                // Test render with pattern
                visualEngine.updatePattern(testPatterns.tresillo);
                visualEngine.render();
                displayResult('basicTestResults', 'Pattern Render', true);
                
            } catch (error) {
                displayResult('basicTestResults', 'Rendering', false, error.message);
            }
        }
        
        function testResponsiveResize() {
            logMessage('üß™ Testing responsive resize...');
            
            if (!visualEngine) {
                displayResult('basicTestResults', 'Responsive Resize', false, 'Engine not initialized');
                return;
            }
            
            try {
                const originalSize = visualEngine.config.canvasSize;
                
                // Trigger resize
                visualEngine.setupResponsiveCanvas();
                
                const newSize = visualEngine.config.canvasSize;
                const sizeUpdated = newSize > 0;
                
                displayResult('basicTestResults', 'Responsive Resize', sizeUpdated,
                    `${originalSize}px ‚Üí ${newSize}px`);
                
            } catch (error) {
                displayResult('basicTestResults', 'Responsive Resize', false, error.message);
            }
        }
        
        // === PATTERN TESTING ===
        
        function loadTestPattern(patternName) {
            if (patternName === 'random') {
                const pattern = {
                    steps: Array(16).fill(false).map(() => Math.random() < 0.4),
                    stepCount: 16,
                    name: 'Random Pattern'
                };
                testPatterns.random = pattern;
            }
            
            const pattern = testPatterns[patternName];
            if (!pattern) return;
            
            if (visualEngine) {
                visualEngine.updatePattern(pattern);
            }
            if (visualEngine2) {
                visualEngine2.updatePattern(pattern);
            }
            
            // Update display
            const display = document.getElementById('currentPattern');
            const visual = pattern.steps.map(s => s ? '‚óè' : '‚àÖ').join(' ');
            display.textContent = `${pattern.name}: ${visual}`;
            
            logMessage(`üéµ Loaded pattern: ${pattern.name}`);
        }
        
        function testPatternUpdate() {
            logMessage('üß™ Testing pattern updates...');
            
            if (!visualEngine) {
                displayResult('patternTestResults', 'Pattern Update', false, 'Engine not initialized');
                return;
            }
            
            try {
                // Test different patterns
                const patterns = ['tresillo', 'fourOnFloor', 'euclidean'];
                let allPassed = true;
                
                for (const patternName of patterns) {
                    visualEngine.updatePattern(testPatterns[patternName]);
                    const updated = visualEngine.pattern.stepCount === testPatterns[patternName].stepCount;
                    if (!updated) allPassed = false;
                }
                
                displayResult('patternTestResults', 'Multiple Pattern Updates', allPassed);
                
            } catch (error) {
                displayResult('patternTestResults', 'Pattern Update', false, error.message);
            }
        }
        
        function testCogCalculation() {
            logMessage('üß™ Testing CoG calculation...');
            
            if (!visualEngine) {
                displayResult('patternTestResults', 'CoG Calculation', false, 'Engine not initialized');
                return;
            }
            
            try {
                // Load tresillo pattern
                visualEngine.updatePattern(testPatterns.tresillo);
                
                const cogCalculated = visualEngine.cogData.isCalculated;
                const hasDistance = typeof visualEngine.cogData.distance === 'number';
                const hasCoordinates = typeof visualEngine.cogData.x === 'number' && typeof visualEngine.cogData.y === 'number';
                
                displayResult('patternTestResults', 'CoG Calculation', cogCalculated);
                displayResult('patternTestResults', 'CoG Distance', hasDistance,
                    hasDistance ? `Distance: ${visualEngine.cogData.distance.toFixed(3)}` : '');
                displayResult('patternTestResults', 'CoG Coordinates', hasCoordinates,
                    hasCoordinates ? `(${visualEngine.cogData.x.toFixed(3)}, ${visualEngine.cogData.y.toFixed(3)})` : '');
                
            } catch (error) {
                displayResult('patternTestResults', 'CoG Calculation', false, error.message);
            }
        }
        
        function testStepToggling() {
            logMessage('üß™ Testing step toggling...');
            
            if (!visualEngine) {
                displayResult('patternTestResults', 'Step Toggling', false, 'Engine not initialized');
                return;
            }
            
            try {
                // Clear pattern first
                const emptyPattern = { steps: Array(8).fill(false), stepCount: 8 };
                visualEngine.updatePattern(emptyPattern);
                
                // Toggle some steps
                visualEngine.toggleStep(0);
                visualEngine.toggleStep(3);
                visualEngine.toggleStep(6);
                
                const step0Active = visualEngine.pattern.steps[0];
                const step3Active = visualEngine.pattern.steps[3];
                const step6Active = visualEngine.pattern.steps[6];
                const step1Inactive = !visualEngine.pattern.steps[1];
                
                const allToggled = step0Active && step3Active && step6Active && step1Inactive;
                
                displayResult('patternTestResults', 'Step Toggling', allToggled,
                    `Steps 0,3,6: ${step0Active}, ${step3Active}, ${step6Active}`);
                
            } catch (error) {
                displayResult('patternTestResults', 'Step Toggling', false, error.message);
            }
        }
        
        // === PLAYBACK ANIMATION TESTS ===
        
        function startPlaybackTest() {
            if (!visualEngine) return;
            
            stopPlaybackTest(); // Stop any existing playback
            
            const tempo = parseInt(document.getElementById('tempoSlider').value);
            const stepDuration = (60 / tempo / 4) * 1000; // 16th notes
            
            // Load a test pattern
            loadTestPattern('tresillo');
            
            currentStep = 0;
            playbackInterval = setInterval(() => {
                visualEngine.updatePlayback({
                    currentStep: currentStep,
                    isPlaying: true
                });
                
                if (visualEngine2) {
                    visualEngine2.updatePlayback({
                        currentStep: currentStep,
                        isPlaying: true
                    });
                }
                
                currentStep = (currentStep + 1) % visualEngine.pattern.stepCount;
            }, stepDuration);
            
            logMessage(`üé¨ Started playback animation at ${tempo} BPM`);
        }
        
        function stopPlaybackTest() {
            if (playbackInterval) {
                clearInterval(playbackInterval);
                playbackInterval = null;
                
                if (visualEngine) {
                    visualEngine.updatePlayback({ currentStep: 0, isPlaying: false });
                }
                if (visualEngine2) {
                    visualEngine2.updatePlayback({ currentStep: 0, isPlaying: false });
                }
                
                logMessage('üõë Stopped playback animation');
            }
        }
        
        function testAnimationPerformance() {
            logMessage('üß™ Testing animation performance...');
            
            if (!visualEngine) {
                displayResult('playbackTestResults', 'Animation Performance', false, 'Engine not initialized');
                return;
            }
            
            const startTime = performance.now();
            let frameCount = 0;
            
            const testAnimation = () => {
                visualEngine.render();
                frameCount++;
                
                if (frameCount < 60) {
                    requestAnimationFrame(testAnimation);
                } else {
                    const endTime = performance.now();
                    const duration = endTime - startTime;
                    const fps = Math.round((frameCount * 1000) / duration);
                    
                    displayResult('playbackTestResults', 'Animation Performance', fps > 30,
                        `${fps} FPS (${frameCount} frames in ${duration.toFixed(1)}ms)`);
                }
            };
            
            testAnimation();
        }
        
        // === THEME TESTING ===
        
        function applyTheme(themeName) {
            if (!visualEngine) return;
            
            let themeConfig;
            switch (themeName) {
                case 'dark':
                    themeConfig = VisualConfigPresets.getDarkTheme();
                    break;
                case 'highContrast':
                    themeConfig = VisualConfigPresets.getHighContrastTheme();
                    break;
                case 'minimal':
                    themeConfig = VisualConfigPresets.getMinimalTheme();
                    break;
                default:
                    // Reset to default
                    visualEngine.config.colors = new SequencerVisualEngine('dummy', 'dummy').config.colors;
                    visualEngine.render();
                    logMessage(`üé® Applied default theme`);
                    return;
            }
            
            visualEngine.updateConfig(themeConfig);
            if (visualEngine2) {
                visualEngine2.updateConfig(themeConfig);
            }
            
            logMessage(`üé® Applied ${themeName} theme`);
        }
        
        function testThemeApplication() {
            logMessage('üß™ Testing theme changes...');
            
            if (!visualEngine) {
                displayResult('themeTestResults', 'Theme Application', false, 'Engine not initialized');
                return;
            }
            
            try {
                const themes = ['dark', 'highContrast', 'minimal', 'default'];
                let allApplied = true;
                
                for (const theme of themes) {
                    applyTheme(theme);
                    // Small delay to see the change
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                displayResult('themeTestResults', 'Theme Application', allApplied,
                    `Applied ${themes.length} themes successfully`);
                
            } catch (error) {
                displayResult('themeTestResults', 'Theme Application', false, error.message);
            }
        }
        
        function testConfigUpdates() {
            logMessage('üß™ Testing config updates...');
            
            if (!visualEngine) {
                displayResult('themeTestResults', 'Config Updates', false, 'Engine not initialized');
                return;
            }
            
            try {
                const originalPulse = visualEngine.config.pulseIntensity;
                
                visualEngine.updateConfig({
                    pulseIntensity: 0.5,
                    animationSpeed: 0.2
                });
                
                const newPulse = visualEngine.config.pulseIntensity;
                const configUpdated = newPulse !== originalPulse;
                
                displayResult('themeTestResults', 'Config Updates', configUpdated,
                    `Pulse: ${originalPulse} ‚Üí ${newPulse}`);
                
            } catch (error) {
                displayResult('themeTestResults', 'Config Updates', false, error.message);
            }
        }
        
        // === INTERACTION TESTS ===
        
        function testClickDetection() {
            logMessage('üß™ Testing click detection...');
            
            if (!visualEngine) {
                displayResult('interactionTestResults', 'Click Detection', false, 'Engine not initialized');
                return;
            }
            
            try {
                // Test getStepAtPosition method
                const centerX = visualEngine.config.centerX;
                const centerY = visualEngine.config.centerY;
                const stepRadius = visualEngine.config.canvasSize * visualEngine.config.stepRadius;
                
                // Calculate position of first step (top of circle)
                const step0X = centerX;
                const step0Y = centerY - stepRadius;
                
                const detectedStep = visualEngine.getStepAtPosition(step0X, step0Y);
                const correctDetection = detectedStep === 0;
                
                displayResult('interactionTestResults', 'Click Detection', correctDetection,
                    `Expected step 0, detected step ${detectedStep}`);
                
                // Test invalid position
                const invalidStep = visualEngine.getStepAtPosition(0, 0);
                const correctInvalid = invalidStep === -1;
                
                displayResult('interactionTestResults', 'Invalid Click Detection', correctInvalid,
                    `Invalid position returned ${invalidStep}`);
                
            } catch (error) {
                displayResult('interactionTestResults', 'Click Detection', false, error.message);
            }
        }
        
        function testHoverEffects() {
            logMessage('üß™ Testing hover effects...');
            
            // This test checks if cursor changes are properly handled
            const canvas = visualEngine?.canvas;
            if (!canvas) {
                displayResult('interactionTestResults', 'Hover Effects', false, 'Canvas not available');
                return;
            }
            
            try {
                // Simulate mouse events
                const mouseEvent = new MouseEvent('mousemove', {
                    clientX: canvas.getBoundingClientRect().left + canvas.width / 2,
                    clientY: canvas.getBoundingClientRect().top + 50
                });
                
                canvas.dispatchEvent(mouseEvent);
                
                displayResult('interactionTestResults', 'Hover Effects', true,
                    'Mouse events handled without error');
                
            } catch (error) {
                displayResult('interactionTestResults', 'Hover Effects', false, error.message);
            }
        }
        
        function testPatternEvents() {
            logMessage('üß™ Testing pattern events...');
            
            if (!visualEngine) {
                displayResult('interactionTestResults', 'Pattern Events', false, 'Engine not initialized');
                return;
            }
            
            try {
                let eventFired = false;
                
                // Add event listener
                visualEngine.canvas.addEventListener('patternChanged', (event) => {
                    eventFired = true;
                    logMessage(`üéµ Pattern change event: ${JSON.stringify(event.detail)}`);
                });
                
                // Trigger pattern change
                visualEngine.toggleStep(0);
                
                // Check if event fired
                setTimeout(() => {
                    displayResult('interactionTestResults', 'Pattern Events', eventFired,
                        eventFired ? 'Pattern change event fired' : 'No event detected');
                }, 100);
                
            } catch (error) {
                displayResult('interactionTestResults', 'Pattern Events', false, error.message);
            }
        }
        
        // === PERFORMANCE TESTS ===
        
        function testRenderPerformance() {
            logMessage('üß™ Testing render performance...');
            
            if (!visualEngine) {
                displayResult('performanceTestResults', 'Render Performance', false, 'Engine not initialized');
                return;
            }
            
            const iterations = 100;
            const startTime = performance.now();
            
            for (let i = 0; i < iterations; i++) {
                visualEngine.render();
            }
            
            const endTime = performance.now();
            const totalTime = endTime - startTime;
            const avgTime = totalTime / iterations;
            const fps = Math.round(1000 / avgTime);
            
            displayResult('performanceTestResults', 'Render Performance', fps > 30,
                `${avgTime.toFixed(2)}ms per frame (${fps} FPS)`);
        }
        
        function testLargePatterns() {
            logMessage('üß™ Testing large patterns...');
            
            if (!visualEngine) {
                displayResult('performanceTestResults', 'Large Patterns', false, 'Engine not initialized');
                return;
            }
            
            try {
                // Test with 64-step pattern
                const largePattern = {
                    steps: Array(64).fill(false).map((_, i) => i % 3 === 0),
                    stepCount: 64
                };
                
                const startTime = performance.now();
                visualEngine.updatePattern(largePattern);
                visualEngine.render();
                const endTime = performance.now();
                
                const renderTime = endTime - startTime;
                const acceptable = renderTime < 50; // Less than 50ms
                
                displayResult('performanceTestResults', 'Large Patterns', acceptable,
                    `64 steps rendered in ${renderTime.toFixed(2)}ms`);
                
            } catch (error) {
                displayResult('performanceTestResults', 'Large Patterns', false, error.message);
            }
        }
        
        function testMemoryUsage() {
            logMessage('üß™ Testing memory usage...');
            
            if (!window.performance || !window.performance.memory) {
                displayResult('performanceTestResults', 'Memory Usage', false, 'Memory API not available');
                return;
            }
            
            try {
                const before = window.performance.memory.usedJSHeapSize;
                
                // Create and destroy multiple engines
                for (let i = 0; i < 10; i++) {
                    const tempEngine = new SequencerVisualEngine('testCanvas', 'testCanvasContainer');
                    tempEngine.updatePattern(testPatterns.tresillo);
                    tempEngine.render();
                    tempEngine.destroy();
                }
                
                // Force garbage collection if available
                if (window.gc) {
                    window.gc();
                }
                
                setTimeout(() => {
                    const after = window.performance.memory.usedJSHeapSize;
                    const memoryIncrease = after - before;
                    const acceptable = memoryIncrease < 1000000; // Less than 1MB increase
                    
                    displayResult('performanceTestResults', 'Memory Usage', acceptable,
                        `Memory increase: ${(memoryIncrease / 1024).toFixed(1)}KB`);
                }, 1000);
                
            } catch (error) {
                displayResult('performanceTestResults', 'Memory Usage', false, error.message);
            }
        }
        
        // === STATISTICS ===
        
        function updateStats() {
            if (!visualEngine) return;
            
            const stats = visualEngine.getStats();
            const statsContainer = document.getElementById('visualStats');
            
            statsContainer.innerHTML = `
                <div class="stat-item">
                    <span class="stat-label">Canvas Size:</span>
                    <span class="stat-value">${stats.canvasSize}px</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Step Count:</span>
                    <span class="stat-value">${stats.stepCount}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">CoG Calculated:</span>
                    <span class="stat-value">${stats.cogCalculated ? 'Yes' : 'No'}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">CoG Distance:</span>
                    <span class="stat-value">${stats.cogDistance ? stats.cogDistance.toFixed(3) : 'N/A'}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Frames Rendered:</span>
                    <span class="stat-value">${stats.framesRendered}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Last Render Time:</span>
                    <span class="stat-value">${stats.lastRenderTime.toFixed(2)}ms</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Average FPS:</span>
                    <span class="stat-value">${stats.averageFPS || 'N/A'}</span>
                </div>
            `;
        }
        
        // === RUN ALL TESTS ===
        
        async function runAllTests() {
            clearResults();
            logMessage('üöÄ Starting comprehensive visual test suite...');
            
            // Basic tests
            testInitialization();
            await new Promise(resolve => setTimeout(resolve, 100));
            
            testCanvasSetup();
            await new Promise(resolve => setTimeout(resolve, 100));
            
            testRendering();
            await new Promise(resolve => setTimeout(resolve, 100));
            
            testResponsiveResize();
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // Pattern tests
            testPatternUpdate();
            await new Promise(resolve => setTimeout(resolve, 100));
            
            testCogCalculation();
            await new Promise(resolve => setTimeout(resolve, 100));
            
            testStepToggling();
            await new Promise(resolve => setTimeout(resolve, 200));
            
            // Animation test
            testAnimationPerformance();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Theme tests
            await testThemeApplication();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            testConfigUpdates();
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // Interaction tests
            testClickDetection();
            await new Promise(resolve => setTimeout(resolve, 100));
            
            testHoverEffects();
            await new Promise(resolve => setTimeout(resolve, 100));
            
            testPatternEvents();
            await new Promise(resolve => setTimeout(resolve, 200));
            
            // Performance tests
            testRenderPerformance();
            await new Promise(resolve => setTimeout(resolve, 200));
            
            testLargePatterns();
            await new Promise(resolve => setTimeout(resolve, 200));
            
            testMemoryUsage();
            
            updateStats();
            logMessage('‚úÖ All visual tests completed!');
        }
        
        // Setup interactive controls
        function setupInteractiveControls() {
            const tempoSlider = document.getElementById('tempoSlider');
            
            tempoSlider.addEventListener('input', (e) => {
                document.getElementById('tempoDisplay').textContent = e.target.value;
            });
        }
        
        // Initialize on load
        window.addEventListener('load', () => {
            setupInteractiveControls();
            initializeEngines();
            updateStats();
            
            // Load default pattern
            setTimeout(() => {
                loadTestPattern('tresillo');
            }, 100);
            
            logMessage('üé® Sequencer Visual Test Suite ready!');
        });
        
        // Cleanup on unload
        window.addEventListener('beforeunload', () => {
            stopPlaybackTest();
            if (visualEngine) {
                visualEngine.destroy();
            }
            if (visualEngine2) {
                visualEngine2.destroy();
            }
        });
    </script>
</body>
</html>